<html>
  <head>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src='../lib/underscore-min.js'></script>
    <script src='../lib/underscoreAddon.js'></script>
    <script src="../src/PykUtil.js"></script>
    <script src="../src/PykQuery.js"></script>
    <script src="../src/PykQuery.adapter.inbrowser.js"></script>
  </head>
  <body>
    <h3>Testing #1: Filters with two tables</h3>
    <div id="reset">Reset All</div>
    <div id="g1">
      <div id='a' style="float:left;margin-left:100px;"></div>
      <div id='b' style="float:left;margin-left:100px;"></div>
    </div>
    <script type="text/javascript">

      $("#reset").click (function () {
        console.log(g1.filters);
        g1.resetFilters();
        console.log(g1.filters);
        g1.call();
        var dd = a.flushToGet();
        var ee = b.flushToGet();
        render(dd,ee)
      })

      var filter1 = function (value) {
        a.addFilter({"column_name": "city", "condition_type": "values", "in": [value], "next": "OR"}, true);
        g1.call();
        var dd = a.flushToGet();
        var ee = b.flushToGet();
        render(dd,ee)
      };
      var filter2 = function (value) {
        b.addFilter({"column_name": "zip", "condition_type": "values", "in": [parseInt(value,10)], "next": "OR"}, true);
        g1.call();
        var dd = a.flushToGet();
        var ee = b.flushToGet();
        render(dd,ee)
      };
      function render (obj1,obj2) {
        //console.log(obj1,obj2)
        var html1 = "<table><tr><td>City</td><td>Price</td></tr>";
        for (var i = 0; i< obj1.length; i++) {
          html1 += "<tr><td><a class='filter1' onclick=filter1('"+obj1[i].city+"');>"+obj1[i].city+"</a></td><td>"+obj1[i].price+"</td></tr>"
        }
        html1 += "</table>";

        var html2 = "<table><tr><td>Zip</td><td>Beds</td></tr>";
        for (var i = 0; i< obj2.length; i++) {
          html2 += "<tr><td><a class='filter2' onclick=filter2('"+obj2[i].zip+"');>"+obj2[i].zip+"</a></td><td>"+obj2[i].beds+"</td></tr>"
        }
        html2 += "</table>";

        document.getElementById(a.div_id).innerHTML = html1;
        document.getElementById(b.div_id).innerHTML = html2;
      }

      var a = new PykQuery.init("aggregation", "local", "a", "inbrowser");
      a.storeObjectInMemory('a');
      a.dimensions = ["city"];
      a.metrics = {"price":["sum"]}//, {"sd": ["min"]}, {"sd": ["min"]}];

      var b = new PykQuery.init("aggregation", "local", "b", "inbrowser");
      b.storeObjectInMemory('b');
      b.dimensions = ["zip"];
      b.metrics = {"beds":["count"]}//, {"sd": ["min"]}, {"sd": ["min"]}];

      var xmlhttp = new XMLHttpRequest();
      var url = "data/test1data.json";
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

          g1 = new PykQuery.init("global", "global", "g1", "inbrowser");
          g1.storeObjectInMemory('g1');
          g1.rawdata = JSON.parse(xmlhttp.response);
          g1.addImpacts(["a", "b"], true);

          a.addFilter({"column_name": "type", "condition_type": "values", "in": ["Residential", "Multi-Family"], "next": "OR"}, false);
          b.addFilter({"column_name": "type", "condition_type": "values", "in": ["Residential", "Multi-Family"], "next": "OR"}, false);

          a.call();
          b.call();
          var d = a.flushToGet();
          var e = b.flushToGet();
          render(d,e);
        }
      }
      xmlhttp.open("GET", url, true);
      xmlhttp.send();
    </script>
  </body>
</html>
