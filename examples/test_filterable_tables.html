<html>
<head>
<script src="lib/jquery-1.11.1.min.js"></script>
<script src='../lib/underscore-min.js'></script>
<script src='../lib/underscoreAddon.js'></script>
<script src="../src/PykUtil.js"></script>
<script src="../src/PykQuery.js"></script>
<script src="../src/filterList.js"></script>
<script src="../src/PykQuery.adapter.inbrowser.js"></script>
<style>
.selected {
  background-color: #f7b77f;
}
</style>
</head>
<body>
  <h3>Testing #1: Filters with two tables</h3>
  <div id="reset">Reset All</div>
  <div id="g1" style='float:left;'>
    <div id='a' style="float:left;margin-left:100px;"></div>
    <div id='b' style="float:left;margin-left:100px;"></div>
  </div>
  <div id="list_of_filters" style='margin-left:50px;float:left;'>&nbsp;</div>
  <div id="save_filters_form" style='margin-left:50px;float:left;'>
    <textarea id="filters_json" cols=100 rows=20></textarea><br/>
    <input id="save_filters" type="button" value="Save" />
  </div>

  <script type="text/javascript">
    $(document).ready(function () {

      var PykCharts = {}
      PykCharts.table1 = function (options) {
        var that = this;

        this.execute = function () {
          var obj1 = this.a.flushToGet();
          console.log(obj1);

          var html1 = "<table><tr><td>City</td><td>Price</td></tr>";
          for (var i = 0; i< obj1.length; i++) {
            html1 += "<tr><td><a data-id='"+obj1[i].city+"' class='filter1'>"+obj1[i].city+"</a></td><td>"+obj1[i].price+"</td></tr>"
          }
          html1 += "</table>";

          document.getElementById(options.selector).innerHTML = html1;

          $(".filter1").click(function () {
            var value = $(this).html(),
                id = $(this).attr('data-id');
                console.log(id);
            that.a.addFilter({"column_name": "city", "condition_type": "values", "in": [value], "next": "OR", "selected_dom_id": id}, true);
            g1.call();
            // var ee = that.b.flushToGet();
          });
        }

        this.a = new PykQuery.init(this, "aggregation", "local", "a", "inbrowser");
        this.a.storeObjectInMemory('a');
        this.a.dimensions = ["city"];
        this.a.metrics = {"price":["sum"]}//, {"sd": ["min"]}, {"sd": ["min"]}];

        this.a.addFilter({"column_name": "type", "condition_type": "values", "in": ["Residential", "Multi-Family"], "next": "OR"}, false);
      }

      PykCharts.table2 = function (options) {
        var that = this;
        this.execute = function () {
          var obj2 = this.b.flushToGet();
          var html2 = "<table><tr><td>Zip</td><td>Beds</td></tr>";
          for (var i = 0; i< obj2.length; i++) {
            html2 += "<tr><td><a data-id='"+obj2[i].zip+"' class='filter2'>"+obj2[i].zip+"</a></td><td>"+obj2[i].beds+"</td></tr>"
          }
          html2 += "</table>";
          document.getElementById(options.selector).innerHTML = html2;

          $(".filter2").click(function () {
            var value = $(this).html(),
            id = $(this).attr('data-id');
            that.b.addFilter({"column_name": "zip", "condition_type": "values", "in": [parseInt(value,10)], "next": "OR", "selected_dom_id": id}, true);
            g1.call();
            // var dd = that.a.flushToGet();
          });
        }

        this.b = new PykQuery.init(this, "aggregation", "local", "b", "inbrowser");
        this.b.storeObjectInMemory('b');
        this.b.dimensions = ["zip"];
        this.b.metrics = {"beds":["count"]}//, {"sd": ["min"]}, {"sd": ["min"]}];

        this.b.addFilter({"column_name": "type", "condition_type": "values", "in": ["Residential", "Multi-Family"], "next": "OR"}, false);
      }

      var k = new PykCharts.table1({
        selector: "a"
      });
      var l = new PykCharts.table2({
        selector: "b"
      });

      var xmlhttp = new XMLHttpRequest();
      var url = "data/test1data.json";
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

          g1 = new PykQuery.init(window, "global", "global", "g1", "inbrowser");
          g1.storeObjectInMemory('g1');
          g1.rawdata = JSON.parse(xmlhttp.response);
          g1.addImpacts(["a", "b"], true);
          g1.filterList("list_of_filters");
          $("#reset").click (function () {
            g1.resetFilters();
            g1.call();
          });
          k.a.call();
          k.a.toSql();
          l.b.call();
        }
      }
      xmlhttp.open("GET", url, true);
      xmlhttp.send();

    })

  </script>
</body>
</html>
