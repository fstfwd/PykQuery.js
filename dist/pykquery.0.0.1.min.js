PykUtil={},PykUtil.init=function(){this.pushToArray=function(a,b){return 0==a.length?a=[b]:a.push(b),a},this.concat_and_uniq=function(a,b){return void 0!=a&&void 0!=b&&(a=a.concat(b).filter(function(a,b,c){return c.indexOf(a)===b})),a},this.is_exactly_same=function(a,b){if(void 0!=a&&void 0!=b){var c=a.length==b.length&&a.every(function(a,c){return a===b[c]});return c}return!1},this.subtract_array=function(a,b){if(void 0!=a&&void 0!=b)for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);d>-1&&a.splice(d,1)}return a},this.isBlank=function(a){return void 0==a||""==a?!0:!1}};var PykQuery={};PykQuery.global_names=[],PykQuery.local_names=[],PykQuery.init=function(a,b,c,d){that=this;var e,f,g,h,i,j,k,l,m=d,n=["aggregation","unique","select","datatype","global"],o=["local","global"],p=["inbrowser","rumi"],q=new PykUtil.init;if(!(n.indexOf(a)>-1&&o.indexOf(b)>-1&&!q.isBlank(c)&&p.indexOf(d)>-1))return-1==n.indexOf(f)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": mode has invalid value. It should be one of "+n),-1==o.indexOf(g)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope has invalid value. It should be one of "+o),-1==p.indexOf(h)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": adapters has invalid value. It should be one of "+p),q.isBlank(divid)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": DivID cannot be undefined."),"global"==f&&"global"!=g&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope and mode both should be global."),!1;if(f=a,g=b,h=d,e="local"==g?c.replace("#",""):c,i="global"==g?_.find(PykQuery.global_names,function(a){return a==e}):null,j="local"==g?_.find(PykQuery.local_names,function(a){return a==e}):null,"global"==f&&"global"!=g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": scope and mode both should be global."),!1;if(void 0==i&&"global"==g)PykQuery.global_names.push(e),flag=!0;else{if(void 0!=j||"local"!=g)return flag=!1,!1;PykQuery.local_names.push(e),flag=!0}var r,s,t,u=[],v=[],w={},x=[],y={},z=2e3,A=[],B=0,C={};switch("global"==f&&"global"==g&&"inbrowser"==h&&Object.defineProperty(this,"rawdata",{get:function(){return s},set:function(a){s=a}}),"local"==g&&"inbrowser"==h&&Object.defineProperty(this,"global_divid_for_raw_data",{get:function(){return t},set:function(a){t=a}}),"rumi"==h&&Object.defineProperty(this,"rumiparams",{get:function(){return m},set:function(a){m=a}}),Object.defineProperty(this,"scope",{get:function(){return g}}),f){case"select":Object.defineProperty(this,"select",{get:function(){return x},set:function(a){x=a}});break;case"aggregation":Object.defineProperty(this,"dimensions",{get:function(){return v},set:function(a){_.each(a,function(a){v.push(a)})}}),Object.defineProperty(this,"metrics",{get:function(){return w},set:function(a){if(K(a))for(var b in a)w[b]=a[b]}});break;case"unique":Object.defineProperty(this,"unique",{get:function(){return x},set:function(a){_.each(a,function(a){x.push(a)})}});break;case"datatype":console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","datatype is currently a missing functionality.")}Object.defineProperty(this,"div_id",{get:function(){return e}}),Object.defineProperty(this,"selecteddomid",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(this,"localdividtriggeringevent",{get:function(){return l},set:function(a){l=a}}),Object.defineProperty(this,"filterdata",{get:function(){return r},set:function(a){r=a}}),Object.defineProperty(this,"limit",{get:function(){return z},set:function(a){z=a}}),Object.defineProperty(this,"mode",{get:function(){return f}}),Object.defineProperty(this,"offset",{get:function(){return B},set:function(a){B=a}}),Object.defineProperty(this,"impacts",{get:function(){return A},set:function(a){I(a)&&A.push(a)}}),Object.defineProperty(this,"alias",{get:function(){return C},set:function(a){if(columns=Object.keys(a),columns.length<1)return void console.warn("Need atleast 1 alias name to add");for(var b in a)a.hasOwnProperty(b)&&(C[b]=a[b])}}),Object.defineProperty(this,"sort",{get:function(){return y},set:function(a){for(var b in a){if(q.isBlank(b))return void console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in sort.");(q.isBlank(a[b])||"asc"!=a[b]&&"desc"!=a[b])&&(a[b]="asc")}y=a}}),this.filter=function(){Object.defineProperty(this,"filters",{get:function(){return u},set:function(a){u=a}})},this.addFilter=function(a,b){this.filters||this.filter(),J(a)&&(b&&"global"==g?F(a):b&&"local"==g?(a.local_div_id_triggering_event=e,G(a),Q()):(b||"global"!=g)&&(b||"local"!=g||F(a)))},this.resetFilters=function(){"global"==g?u=[]:console.error("You cannot reset a local. Please run it on a Global.")},this.removeFilter=function(a,b,c,d){J(name)&&(d&&"global"==g?D(a,b,c):d&&"local"==g?E(a,b,c):(d||"global"!=g)&&(d||"local"!=g||D(a,b,c)))};var D=function(a,b,c){for(var d=u.length,e=0;d>e;e++)if(u[e].column_name==a&&u[e].condition_type==b)if("values"==b)u[e]["in"]=q.subtract_array(u[e]["in"],c["in"]),u[e].not_in=q.subtract_array(u[e].not_in,c.not_in);else if("range"==b){var f=c.min,g=c.max;q.isBlank(f)||q.isBlank(g)||f==u[e].condition.min&&g==u[e].condition.max&&u.splice(e,1)}},E=function(a,b,c){if("local"==g)for(var d=impacts.length,e=0;d>e;e++){var f=window[impacts[e]];f.removeFilterInQuery(a,b,c)}},F=function(a){for(var b=!0,c=0;c<u.length;c++){var d=u[c];if(d.column_name==a.column_name&&d.condition_type==a.condition_type){if("values"==d.condition_type){var e=q.is_exactly_same(a["in"],d["in"]),f=q.is_exactly_same(a.not_in,d.not_in);if(1==f&&1==e)return console.warn("Clean up your JS: Same filter cannot add"),!1;d["in"]=q.concat_and_uniq(d["in"],a["in"]),d.not_in=q.concat_and_uniq(d.not_in,a.not_in),u[c]=d,b=!1;break}if("range"==d.condition_type){var g=a.condition,h=d.condition;if(g.min==h.min&&g.max==h.max&&g.not==h.not)return console.warn("Clean up your JS: Same filter cannot add"),!1;b=!0}}}1==b&&u.push(a)},G=function(a){if("local"==g)for(var b=A.length,c=0;b>c;c++){var d=window[A[c]];d.addFilter(a,!0,e)}};this.addImpacts=function(a,b){window[a[c]];if(I(a)){len=a.length;for(var c=0;len>c;c++)A.push(a[c]),H(this,a[0]),b&&(H(window[a[c]],this.div_id),related_pykquery=window[a[c]],related_pykquery.impacts=[this.div_id])}};var H=function(a,b){"inbrowser"===h&&"local"===a.scope&&(a.global_divid_for_raw_data||(a.global_divid_for_raw_data=b))},I=function(a){var b,c=a.length;b="local"===g?"global":"local";for(var d=0;c>d;d++){var e=window[a[d]];if(e&&e.scope===g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","A "+g+" can only impact a "+b+"."),!1}return!0},J=function(a){return 0==Object.keys(a).length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Empty filter object is not allowed."),!1):q.isBlank(a.column_name)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'column_name' cannot be empty."),!1):q.isBlank(a.next)||"OR"==a.next||"AND"==a.next?"range"==a.condition_type?q.isBlank(a.condition)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'condition' cannot be empty."),!1):q.isBlank(a.condition.min)&&q.isBlank(a.condition.max)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'min' or 'max' or both must always be present."),!1):!0:"values"==a.condition_type?q.isBlank(a.not_in)&&q.isBlank(a["in"])?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):void 0!=a.not_in&&void 0!=a["in"]&&0==a.not_in.length&&0==a["in"].length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):!0:(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": 'condition_type' must be one of "+["range","values"]+"."),!1):(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'next' must either be empty or OR or AND."),!1)},K=function(a){var b=["min","max","avg","sum","median","count"];if(0==Object.keys(a).length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'metrics' object cannot be empty."),!1;for(var c in a){if(q.isBlank(c))return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in 'metrics'."),!1;if(q.isBlank(a[c])||0==a[c].length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Please pass an Array of metric functions for column name '"+c+"'."),!1;for(var d=a[c].length,e=0;d>e;e++)if(b.indexOf(a[c][e])<=-1)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Wrong metric function passed for column name '"+c+"'."),!1}return!0};this.flushToGet=function(){if("local"==g){var a=r;return r="",a}console.error("Cannot call flushToGet to on a Global PykQuery.")},this.call=function(){var a=this;if("local"==g)N(O(a)),P(a);else for(var b=A.length,c=0;b>c;c++){var d=window[A[c]];d.filter_data=d.call()}return!0};var L=function(){if("local"==g){for(var a=that.filters,b=A.length,c=0;b>c;c++){var d=window[A[c]].filters;d&&d.localdividtriggeringevent!==e&&(a=_.flatten(d,a))}return a}console.error("Cannot call generateConsolidatedFiltersArray to on a Global PykQuery.")},M=function(a){if(a)for(var b=0;b<a.length;b++)document.getElementById(a[b].selected_dom_id).className+=" selected"},N=function(a){var b=L();M(b);if("inbrowser"==h){var c=new PykQuery.adapter.inbrowser.init(a,b);return r=c.call()}var c=new PykQuery.adapter.rumi.init(a,m);return c.call(function(a){return r=a})},O=function(a){var b={},c=Object.getOwnPropertyNames(a);for(var d in c)0==a.propertyIsEnumerable(c[d])&&(b[c[d]]=a[c[d]]);return b};this.storeObjectInMemory=function(a){document.getElementById(e).setAttribute("pyk_object",a)};var P=function(){var a=this,b=(A.length,window[A[0]].filters);b?b.local_div_id_triggering_event!==e&&a.hasOwnProperty("refresh")&&a.refresh():a.hasOwnProperty("execute")&&a.execute()};this.toSql=function(){that=this;var a,b,c=that.filters,d=that.mode,e=that.unique,f=that.metrics,g=that.select,h=that.sort,i=that.dimensions,j=that.limit,k=that.offset,l=that.div_id,m="__",n=that.columns,o=[],p=[],q=[],r="",s="FROM "+m+" ",t=[],u="",v="",w="",x="",y=!1;if(i&&"aggregation"==d){if(f&&0==_.isEmpty(f))for(var z in f){len=f[z].length;for(var A=0;len>A;A++)o.push(f[z][A]+"("+z+")")}if(0==_.isEmpty(i))for(var z=0;z<i.length;z++)0==_.has(f,i[z])&&(o.push(i[z]),p.push(i[z]))}if(g&&"select"==d){if(0===_.intersection(n,g).length&&g.toString()!==["*"].toString())return!1;_.each(g,function(a){o.push(a)})}if(e&&"unique"==d){if(0===_.intersection(n,e).length)return!1;_.each(e,function(a){o.push(a)})}if(r=1==_.isEmpty(o)&&1==_.isEmpty(i)&&"unique"!=d?"SELECT * ":"unique"==d?"SELECT DISTINCT "+o.join(", ")+" ":"SELECT "+o.join(", ")+" ",c&&0==_.isEmpty(c)&&(a=!1,_.each(c,function(d,e){switch(t[e]="",d.condition_type){case"values":b=[],d["in"]&&0!==d["in"].length&&(y=!0,t[e]+=d.column_name+" IN (",_.each(d["in"],function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.not_in&&0!==d.not_in.length&&(t[e]+=y?"AND "+d.column_name+" NOT IN (":d.column_name+" NOT IN (",_.each(d.not_in,function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1;break;case"range":0==_.isEmpty(d.condition)&&(t[e]+=d.column_name+" ",d.condition.not&&(t[e]+="NOT "),t[e]+="BETWEEN "+d.condition.min+" AND "+d.condition.max+" ",d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1);break;case"data_types":}})),i&&"aggregation"===d&&(u="GROUP BY "+p.join(", ")+" "),h&&0==_.isEmpty(h)){v="ORDER BY ";for(key in h)v+=key+" "+h[key]+", ";v=v.slice(0,-2)+" "}w=j?"LIMIT "+j+" ":w,x=k?"OFFSET "+k+" ":x,q=l+": \n "+r+" \n "+s+" \n WHERE";for(var B=t.length,z=0;B>z;z++)q=q+" \n	 "+t[z];return q=q+" \n "+u+" \n "+v+" \n "+w+" \n "+x,console.log(q),q},this.filterList=function(a){$("#"+a).empty(),$("#"+a).append("<div class='filter_list'></div>"),Q(u,a),$(".filter_remove").unbind("click"),$(document).on("click",".filter_remove",function(){var b=$(this).attr("id").split("filter_remove_");R(b[1],u,a)})};var Q=function(){len=u.length,filter_values="values in filter",$(".filter_list").empty();for(var a=0;len>a;a++)$(".filter_list").append("<div class='filter_block' id ='filter_block"+a+"'></div>"),$("#filter_block"+a).append("<div class ='filter_value"+a+"'>"+filter_values+"</div>"),$("#filter_block"+a).append("<div id ='filter_remove_"+a+"'class ='filter_remove'>remove</div>")},R=function(a){u.splice(a,1),Q()}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.rumi={},PykQuery.adapter.rumi.init=function(a,b){this.call=function(d){var e,f;if(!c(b))return!1;var g={config:a,filename:b.filename,username:b.username,projectname:b.projectname};e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),e.onreadystatechange=function(){4==e.readyState&&(201==e.status?(f=e.responseText,console.log(e.responseText,f),d(f)):console.error(400==e.status?"There was an error 400":"something else other than 200 was returned"))},e.open("POST","http://192.168.0.121:9292/v1/filter/show",!1),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),console.log(f,"------response"),e.send(g)};var c=function(a){var b=new PykUtil.init;return console.log(b.isBlank(a)),void 0==a?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Empty rumi parameter object is not allowed."),!1):b.isBlank(a.filename)?(console.log("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","filename missing in rumi parameter"),!1):b.isBlank(a.username)?(console.log("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","username missing in rumi parameter"),!1):b.isBlank(a.projectname)?(console.log("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","projectname missing in rumi parameter"),!1):!0}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.inbrowser={},PykQuery.adapter.inbrowser.init=function(a,b){global_divid_for_raw_data=window[a.global_divid_for_raw_data],c=global_divid_for_raw_data.rawdata;var c,d=a;global_divid_for_raw_data=window[a.global_divid_for_raw_data],c=global_divid_for_raw_data.rawdata,d.filters=b,this.call=function(){var b,c=a.mode;switch(void 0!=d.filters&&d.filters.length>0&&k(d),c){case"aggregation":b=e(d);break;case"unique":break;case"datatype":}return b};var e=function(a){var b=a.metrics;local_data=_.groupBy(c,a.dimensions[0]);for(var d in b){switch(b[d][0]){case"count":local_data=f(local_data,d);break;case"sum":local_data=g(local_data,d);break;case"min":local_data=h(local_data,d);break;case"max":local_data=i(local_data,d);break;case"extent":local_data=j(local_data,d)}return local_data}},f=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=b.length,d.push(f)}),d},g=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=_.sum(b,function(a){return a[c]}),d.push(f)}),d},h=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.min=_.min(a,function(a){return a[b]}),c.push(e)}),c},i=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.max=_.max(a,function(a){return a[b]}),c.push(e)}),c},j=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.extent=_.extent(a,function(a){return a[b]}),c.push(e)}),c},k=function(a){var b,d=a.mode,e=a.filters,f=e.length;b="select"==a.mode?a.select:[];for(var g=0;f>g;g++)switch(e[g].condition_type){case"values":console.log("---- value code"),l(e[g],b,d);break;case"range":console.log("---- range code"),m(e[g],b);break;case"datatype":}return c},l=function(a,b,d){var e=a["in"],f=a.not_in,g=a.column_name;c=_.filter(c,function(a){return!f||f.indexOf(a[g])<0?a:void 0}),c=_.filter(c,function(a){return e&&e.indexOf(a[g])>-1?a:void 0}),0!=b.length&&"select"===d&&(c=_.map(c,function(a){return _.pick(a,b)}))},m=function(a,b,d){var e=a.condition.min,f=a.condition.max,g=a.column_name;c=_.filter(c,function(a){return a[g]<=f&&a[g]>=e?a:void 0}),0!=b.length&&"select"===d&&(c=_.map(c,function(a){return _.pick(a,b)}))}},this.toSql=function(){that=this;var a,b,c=that.filters,d=that.mode,e=that.unique,f=that.metrics,g=that.select,h=that.sort,i=that.dimensions,j=that.limit,k=that.offset,l=that.div_id,m="__",n=that.columns,o=[],p=[],q=[],r="",s="FROM "+m+" ",t=[],u="",v="",w="",x="",y=!1;if(i&&"aggregation"==d){if(f&&0==_.isEmpty(f))for(var z in f){len=f[z].length;for(var A=0;len>A;A++)o.push(f[z][A]+"("+z+")")}if(0==_.isEmpty(i))for(var z=0;z<i.length;z++)0==_.has(f,i[z])&&(o.push(i[z]),p.push(i[z]))}if(g&&"select"==d){if(0===_.intersection(n,g).length&&g.toString()!==["*"].toString())return!1;_.each(g,function(a){o.push(a)})}if(e&&"unique"==d){if(0===_.intersection(n,e).length)return!1;_.each(e,function(a){o.push(a)})}if(r=1==_.isEmpty(o)&&1==_.isEmpty(i)&&"unique"!=d?"SELECT * ":"unique"==d?"SELECT DISTINCT "+o.join(", ")+" ":"SELECT "+o.join(", ")+" ",c&&0==_.isEmpty(c)&&(a=!1,_.each(c,function(d,e){switch(t[e]="",d.condition_type){case"values":b=[],d["in"]&&0!==d["in"].length&&(y=!0,t[e]+=d.column_name+" IN (",_.each(d["in"],function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.not_in&&0!==d.not_in.length&&(t[e]+=y?"AND "+d.column_name+" NOT IN (":d.column_name+" NOT IN (",_.each(d.not_in,function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1;break;case"range":0==_.isEmpty(d.condition)&&(t[e]+=d.column_name+" ",d.condition.not&&(t[e]+="NOT "),t[e]+="BETWEEN "+d.condition.min+" AND "+d.condition.max+" ",d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1);break;case"data_types":}})),i&&"aggregation"===d&&(u="GROUP BY "+p.join(", ")+" "),h&&0==_.isEmpty(h)){v="ORDER BY ";for(key in h)v+=key+" "+h[key]+", ";v=v.slice(0,-2)+" "}w=j?"LIMIT "+j+" ":w,x=k?"OFFSET "+k+" ":x,q=l+": \n "+r+" \n "+s+" \n WHERE";for(var B=t.length,z=0;B>z;z++)q=q+" \n	 "+t[z];return q=q+" \n "+u+" \n "+v+" \n "+w+" \n "+x,console.log(q),q},this.returnsWhereClause=function(a){var b="";switch(a.condition_type){case"values":vals=[],a["in"]&&0!==a["in"].length&&(is_IN=!0,b+=a.column_name+" IN (",_.each(a["in"],function(a){b+=a+", "}),b=b.slice(0,-2)+") "),a.not_in&&0!==a.not_in.length&&(b+=is_IN?"AND "+a.column_name+" NOT IN (":a.column_name+" NOT IN (",_.each(a.not_in,function(a){b+=a+", "}),b=b.slice(0,-2)+") ");break;case"range":0==_.isEmpty(a.condition)&&(b+=a.column_name+" ",a.condition.not&&(b+="NOT "),b+="BETWEEN "+a.condition.min+" AND "+a.condition.max+" ");break;case"data_types":}return b};