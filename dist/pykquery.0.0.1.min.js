PykUtil={},PykUtil.init=function(){this.pushToArray=function(a,b){return 0==a.length?a=[b]:a.push(b),a},this.concat_and_uniq=function(a,b){return void 0!=a&&void 0!=b&&(a=a.concat(b).filter(function(a,b,c){return c.indexOf(a)===b})),a},this.is_exactly_same=function(a,b){if(void 0!=a&&void 0!=b){var c=a.length==b.length&&a.every(function(a,c){return a===b[c]});return c}return!1},this.subtract_array=function(a,b){if(void 0!=a&&void 0!=b)for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);d>-1&&a.splice(d,1)}return a},this.isBlank=function(a){}};var PykQuery={};PykQuery.global_names=[],PykQuery.local_names=[],PykQuery.init=function(a,b,c,d){that=this;var e,f,g,h,i,j,k=["aggregation","unique","select","datatype","global"],l=["local","global"],m=["inbrowser","rumi"],n=new PykUtil.init;if(!(k.indexOf(a)>-1&&l.indexOf(b)>-1&&!n.isBlank(c)&&m.indexOf(d)>-1))return-1==k.indexOf(f)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": mode has invalid value. It should be one of "+k),-1==l.indexOf(g)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope has invalid value. It should be one of "+l),-1==m.indexOf(h)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": adapters has invalid value. It should be one of "+m),n.isBlank(divid)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": DivID cannot be undefined."),"global"==f&&"global"!=g&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope and mode both should be global."),!1;if(f=a,g=b,h=d,e="local"==g?c.replace("#",""):c,i="global"==g?_.find(PykQuery.global_names,function(a){return a==e}):null,j="local"==g?_.find(PykQuery.local_names,function(a){return a==e}):null,"global"==f&&"global"!=g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": scope and mode both should be global."),!1;if(void 0==i&&"global"==g)PykQuery.global_names.push(e),flag=!0;else{if(void 0!=j||"local"!=g)return flag=!1,!1;PykQuery.local_names.push(e),flag=!0}var o,p,q,r=[],s=[],t={},u=[],v={},w=2e3,x=[],y=0,z={};switch("global"==f&&"global"==g&&"inbrowser"==h&&Object.defineProperty(this,"rawdata",{get:function(){return p},set:function(a){p=a}}),"local"==g&&"inbrowser"==h&&Object.defineProperty(this,"global_divid_for_raw_data",{get:function(){return q},set:function(a){q=a}}),"rumi"==h&&Object.defineProperty(this,"datastoreurl",{get:function(){return data_store_url},set:function(a){data_store_url=a}}),Object.defineProperty(this,"scope",{get:function(){return g}}),f){case"select":Object.defineProperty(this,"select",{get:function(){return u},set:function(a){u=a}});break;case"aggregation":Object.defineProperty(this,"dimensions",{get:function(){return s},set:function(a){_.each(a,function(a){s.push(a)})}}),Object.defineProperty(this,"metrics",{get:function(){return t},set:function(a){if(H(a))for(var b in a)t[b]=a[b]}});break;case"unique":Object.defineProperty(this,"unique",{get:function(){return u},set:function(a){_.each(a,function(a){u.push(a)})}});break;case"datatype":return void console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","datatype is currently a missing functionality.")}Object.defineProperty(this,"div_id",{get:function(){return e}}),Object.defineProperty(this,"filterdata",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(this,"limit",{get:function(){return w},set:function(a){w=a}}),Object.defineProperty(this,"mode",{get:function(){return f}}),Object.defineProperty(this,"offset",{get:function(){return y},set:function(a){y=a}}),Object.defineProperty(this,"impacts",{get:function(){return x},set:function(a){F(a)&&x.push(a)}}),Object.defineProperty(this,"alias",{get:function(){return z},set:function(a){if(columns=Object.keys(a),columns.length<1)return void console.warn("Need atleast 1 alias name to add");for(var b in a)a.hasOwnProperty(b)&&(z[b]=a[b])}}),Object.defineProperty(this,"sort",{get:function(){return v},set:function(a){for(var b in a){if(n.isBlank(b))return void console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in sort.");(n.isBlank(a[b])||"asc"!=a[b]&&"desc"!=a[b])&&(a[b]="asc")}v=a}}),this.filter=function(){Object.defineProperty(this,"filters",{get:function(){return r},set:function(a){r=a}})},this.addFilter=function(a,b){this.filters||this.filter(),G(a)&&(b&&"global"==g?C(a):b&&"local"==g?D(a):(b||"global"!=g)&&(b||"local"!=g||C(a)))},this.resetFilters=function(){"global"==g?r=[]:console.error("You cannot reset a local. Please run it on a Global.")},this.removeFilter=function(a,b,c,d){G(name)&&(d&&"global"==g?A(a,b,c):d&&"local"==g?B(a,b,c):(d||"global"!=g)&&(d||"local"!=g||A(a,b,c)))};var A=function(a,b,c){for(var d=r.length,e=0;d>e;e++)if(r[e].column_name==a&&r[e].condition_type==b)if("values"==b)r[e]["in"]=n.subtract_array(r[e]["in"],c["in"]),r[e].not_in=n.subtract_array(r[e].not_in,c.not_in);else if("range"==b){var f=c.min,g=c.max;n.isBlank(f)||n.isBlank(g)||f==r[e].condition.min&&g==r[e].condition.max&&r.splice(e,1)}},B=function(a,b,c){if("local"==g)for(var d=impacts.length,e=0;d>e;e++){var f=window[impacts[e]];f.removeFilterInQuery(a,b,c)}},C=function(a){for(var b=!0,c=0;c<r.length;c++){var d=r[c];if(d.column_name==a.column_name&&d.condition_type==a.condition_type){if("values"==d.condition_type){var e=n.is_exactly_same(a["in"],d["in"]),f=n.is_exactly_same(a.not_in,d.not_in);if(1==f&&1==e)return console.warn("Clean up your JS: Same filter cannot add"),!1;d["in"]=n.concat_and_uniq(d["in"],a["in"]),d.not_in=n.concat_and_uniq(d.not_in,a.not_in),r[c]=d,b=!1;break}if("range"==d.condition_type){var g=a.condition,h=d.condition;if(g.min==h.min&&g.max==h.max&&g.not==h.not)return console.warn("Clean up your JS: Same filter cannot add"),!1;b=!0}}}1==b&&r.push(a)},D=function(a){if("local"==g)for(var b=x.length,c=0;b>c;c++){var d=window[x[c]];d.addFilter(a,!0)}};this.addImpacts=function(a,b){window[a[c]];if(F(a)){len=a.length;for(var c=0;len>c;c++)x.push(a[c]),E(this,a[0]),b&&(E(window[a[c]],this.div_id),related_pykquery=window[a[c]],related_pykquery.impacts=[this.div_id])}};var E=function(a,b){"inbrowser"===h&&"local"===a.scope&&(a.global_divid_for_raw_data||(a.global_divid_for_raw_data=b))},F=function(a){var b,c=a.length;b="local"===g?"global":"local";for(var d=0;c>d;d++){var e=window[a[d]];if(e&&e.scope===g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","A "+g+" can only impact a "+b+"."),!1}return!0},G=function(a){return 0==Object.keys(a).length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Empty filter object is not allowed."),!1):n.isBlank(a.column_name)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'column_name' cannot be empty."),!1):n.isBlank(a.next)||"OR"==a.next||"AND"==a.next?"range"==a.condition_type?n.isBlank(a.condition)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'condition' cannot be empty."),!1):n.isBlank(a.condition.min)&&n.isBlank(a.condition.max)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'min' or 'max' or both must always be present."),!1):!0:"values"==a.condition_type?n.isBlank(a.not_in)&&n.isBlank(a["in"])?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):void 0!=a.not_in&&void 0!=a["in"]&&0==a.not_in.length&&0==a["in"].length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):!0:(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": 'condition_type' must be one of "+["range","values"]+"."),!1):(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'next' must either be empty or OR or AND."),!1)},H=function(a){var b=["min","max","avg","sum","median","count"];if(0==Object.keys(a).length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'metrics' object cannot be empty."),!1;for(var c in a){if(n.isBlank(c))return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in 'metrics'."),!1;if(n.isBlank(a[c])||0==a[c].length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Please pass an Array of metric functions for column name '"+c+"'."),!1;for(var d=a[c].length,e=0;d>e;e++)if(b.indexOf(a[c][e])<=-1)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Wrong metric function passed for column name '"+c+"'."),!1}return!0};this.flushToGet=function(){if("local"==g){var a=o;return o="",a}console.error("Cannot call flushToGet to on a Global PykQuery.")},this.call=function(){var a=this;if("local"==g)J(K(a));else for(var b=x.length,c=0;b>c;c++){var d=window[x[c]];d.filter_data=d.call()}return!0};var I=function(){if("local"==g){for(var a=this.filters,b=x.length,c=0;b>c;c++){var d=window[x[c]];a=_.flatten(d.filters,a)}return a}console.error("Cannot call generateConsolidatedFiltersArray to on a Global PykQuery.")},J=function(a){var b=I();if("inbrowser"==h){var c=new PykQuery.adapter.inbrowser.init(a,b);return o=c.call()}var c=new PykQuery.adapter.rumi.init(a);return c.call(function(a){return o=a})},K=function(a){var b={},c=Object.getOwnPropertyNames(a);for(var d in c)0==a.propertyIsEnumerable(c[d])&&(b[c[d]]=a[c[d]]);return b};this.storeObjectInMemory=function(a){document.getElementById(e).setAttribute("pyk_object",a)};this.toSql=function(){options=this;var a=options.filters,b=options.mode,c=options.metrics,d=options.select_columns,f=options.sort,g=options.dimensions,h=options.limit,i=options.offset,j="__",k=options.columns,l=[];p=[],final_data=[];var m,n,o=[],q="",r="FROM "+j+" ",s="",t="",u="",v="",w="",x=!1;if(g&&"aggregation"===b){l=_.flatten(g);for(var y in c){len=c[y].length;for(var z=0;len>z;z++)l.push(c[y][z]+"("+y+")")}}if(d&&"aggregation"!==b){if(0===_.intersection(k,d).length)return!1;_.each(d,function(a){l.push(a)})}if(q=1==_.isEmpty(l)&&1==_.isEmpty(g)?"SELECT * ":"SELECT "+l.join(", ")+" ",a&&(s="WHERE ",m=!1,_.each(a,function(a){switch(m&&(s+=m+" "),a.condition_type){case"values":n=[],a["in"]&&0!==a["in"].length&&(x=!0,s+=a.column_name+" IN (",_.each(a["in"],function(a){s+=a+", "}),s=s.slice(0,-2)+") "),a.not_in&&0!==a.not_in.length&&(s+=x?"AND "+a.column_name+" NOT IN (":a.column_name+" NOT IN (",_.each(a.not_in,function(a){s+=a+", "}),s=s.slice(0,-2)+") "),m=a.next?a.next:!1;break;case"range":s+=a.column_name+" ",a.condition.not&&(s+="NOT "),s+="BETWEEN "+a.condition.min+" AND "+a.condition.max+" ",m=a.next?a.next:!1;break;case"data_types":}})),g&&"aggregation"===b&&(t="GROUP BY "+g.join(", ")+" "),f){u="ORDER BY ";for(key in f)u+=key+" "+f[key]+", ";u=u.slice(0,-2)+" "}return v=h?"LIMIT "+h+" ":v,w=i?"OFFSET "+i+" ":w,o=e+": "+q+r+s+t+u+v+w}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.rumi={},PykQuery.adapter.rumi.init=function(a){this.call=function(b){var c,d;c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c.onreadystatechange=function(){4==c.readyState&&(201==c.status?(d=c.responseText,console.log(c.responseText,d),b(d)):console.error(400==c.status?"There was an error 400":"something else other than 200 was returned"))},c.open("POST","http://192.168.0.121:9292/v1/filter/show",!1),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),console.log(d,"------response"),c.send(JSON.stringify(a))}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.inbrowser={},PykQuery.adapter.inbrowser.init=function(a,b){global_divid_for_raw_data=window[a.global_divid_for_raw_data],console.log(a),c=global_divid_for_raw_data.rawdata;var c,d=a;global_divid_for_raw_data=window[a.global_divid_for_raw_data],c=global_divid_for_raw_data.rawdata,d.filters=b,this.call=function(){var b,f=a.mode;switch(void 0!=d.filters&&d.filters.length>0&&(c=k(d)),f){case"aggregation":b=e(d);break;case"unique":break;case"datatype":}return b};var e=function(a){var b=a.metrics;local_data=_.groupBy(c,a.dimensions[0]);for(var d in b){switch(b[d][0]){case"count":local_data=f(local_data,d);break;case"sum":local_data=g(local_data,d);break;case"min":local_data=h(local_data,d);break;case"max":local_data=i(local_data,d);break;case"extent":local_data=j(local_data,d)}return local_data}},f=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=b.length,d.push(f)}),d},g=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=_.sum(b,function(a){return a[c]}),d.push(f)}),d},h=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.min=_.min(a,function(a){return a[b]}),c.push(e)}),c},i=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.max=_.max(a,function(a){return a[b]}),c.push(e)}),c},j=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.extent=_.extent(a,function(a){return a[b]}),c.push(e)}),c},k=function(a){var b,d=a.filters,e=d.length;if("select"==a.mode)b=a.select;else if("aggregation"==a.mode){b=a.dimensions;for(var f in a.metrics)b.push(f)}else b=[];for(var g=0;e>g;g++)switch(d[g].condition_type){case"values":return console.log("---- value code"),l(d[g],b);case"range":return console.log("---- range code"),m(d[g],b);case"datatype":}return c},l=function(a){var b=a["in"],d=a.not_in,e=a.column_name;c=_.filter(c,function(a){return!d||d.indexOf(a[e])<0?a:void 0}),c=_.filter(c,function(a){return b&&b.indexOf(a[e])>-1?a:void 0})},m=function(a,b){var d=a.condition.min,e=a.condition.max,f=a.column_name;c=_.filter(c,function(a){return a[f]<=e&&a[f]>=d?a:void 0}),0!=b.length&&(c=_.map(c,function(a){return _.pick(a,b)}))}};