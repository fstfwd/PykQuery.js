function filterDbQueryString(a){var b=a.filter,c=a.mode,d=a.metrics,e=a.select_columns,f=a.sort,g=a.dimensions,h=a.limit,i=a.offset,j="test1data",k=a.columns,l=[];raw_data=[],final_data=[];var m,n,o=[],p="",q="FROM "+j+" ",r="",s="",t="",u="",v="",w=!1;if(g&&"aggregation"===c){if(0===_.intersection(k,g).length)return!1;l=g.slice()}else g=!1;if(e&&"aggregation"!==c){if(0===_.intersection(k,e).length)return!1;_.each(e,function(a){l.push(a)})}if(d&&"aggregation"===c)for(key in d)if(0!==_.intersection(k,[key]).length&&0!==d[key].length){var x="";_.each(d[key],function(a){x=a+"("+key+")",l.push(x)})}if(p=1==_.isEmpty(l)&&1==_.isEmpty(g)?"SELECT * ":"SELECT "+l.join(", ")+" ",b&&(r="WHERE ",m=!1,_.each(b,function(a){switch(m&&(r+=m+" "),a.condition_type){case"values":n=[],a["in"]&&0!==a["in"].length&&(w=!0,r+=a.column_name+" IN (",_.each(a["in"],function(a){r+=a+", "}),r=r.slice(0,-2)+") "),a.not_in&&0!==a.not_in.length&&(r+=w?"AND "+a.column_name+" NOT IN (":a.column_name+" NOT IN (",_.each(a.not_in,function(a){r+=a+", "}),r=r.slice(0,-2)+") "),m=a.next?a.next:!1;break;case"range":r+=a.column_name+" ",a.condition.not&&(r+="NOT "),r+="BETWEEN "+a.condition.min+" AND "+a.condition.max+" ",m=a.next?a.next:!1;break;case"data_types":}})),g&&"aggregation"===c&&(s="GROUP BY "+g.join(", ")+" "),f){t="ORDER BY ";for(key in f)t+=key+" "+f[key]+", ";t=t.slice(0,-2)+" "}else t="ORDER BY "+g[0]+" ";return u=h?"LIMIT "+h+" ":u,v=i?"OFFSET "+i+" ":u,o[0]=p+q+r+s+t+u+v,o[1]=p+"<br/>"+q+"<br/>"+r+"<br/>"+s+"<br/>"+t+"<br/>"+u+"<br/>"+v,o}PykUtil={},PykUtil.init=function(){this.pushToArray=function(a,b){return 0==a.length?a=[b]:a.push(b),a},this.concat_and_uniq=function(a,b){return void 0!=a&&void 0!=b&&(a=a.concat(b).filter(function(a,b,c){return c.indexOf(a)===b})),a},this.is_exactly_same=function(a,b){if(void 0!=a&&void 0!=b){var c=a.length==b.length&&a.every(function(a,c){return a===b[c]});return c}return!1},this.subtract_array=function(a,b){if(void 0!=a&&void 0!=b)for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);d>-1&&a.splice(d,1)}return a},this.isBlank=function(a){}};var PykQuery={};PykQuery.global_names=[],PykQuery.local_names=[],PykQuery.init=function(a,b,c,d){that=this;var e,f,g,h,i,j,k=["aggregation","unique","select","datatype","global"],l=["local","global"],m=["inbrowser","rumi"],n=new PykUtil.init;if(!(k.indexOf(a)>-1&&l.indexOf(b)>-1&&!n.isBlank(c)&&m.indexOf(d)>-1))return-1==k.indexOf(f)&&console.error(divid+": available_mode has invalid value. It should be one of "+k),-1==l.indexOf(g)&&console.error(divid+": available_scope has invalid value. It should be one of "+l),-1==m.indexOf(h)&&console.error(divid+": available_adapters has invalid value. It should be one of "+m),n.isBlank(divid)&&console.error(divid+": DivID cannot be undefined."),"global"==f&&"global"!=g&&console.error(divid+": scope and mode both should be global."),!1;if(f=a,g=b,h=d,e="local"==g?c.replace("#",""):c,i="global"==g?_.find(PykQuery.global_names,function(a){return a==e}):null,j="local"==g?_.find(PykQuery.local_names,function(a){return a==e}):null,"global"==f&&"global"!=g)return console.error(e+": scope and mode both should be global."),!1;if(void 0==i&&"global"==g)PykQuery.global_names.push(e),flag=!0;else{if(void 0!=j||"local"!=g)return flag=!1,!1;PykQuery.local_names.push(e),flag=!0}var o,p,q,r=[],s=[],t={},u=[],v={},w=2e3,x=[],y=0,z={};switch("global"==f&&"global"==g&&"inbrowser"==h&&Object.defineProperty(this,"rawdata",{get:function(){return p},set:function(a){p=a}}),"local"==g&&"inbrowser"==h&&Object.defineProperty(this,"global_divid_for_raw_data",{get:function(){return q},set:function(a){q=a}}),"rumi"==h&&Object.defineProperty(this,"datastoreurl",{get:function(){return data_store_url},set:function(a){data_store_url=a}}),Object.defineProperty(this,"scope",{get:function(){return g}}),f){case"select":Object.defineProperty(this,"select",{get:function(){return u},set:function(a){u=a}});break;case"aggregation":Object.defineProperty(this,"dimensions",{get:function(){return s},set:function(a){_.each(a,function(a){s.push(a)})}}),Object.defineProperty(this,"metrics",{get:function(){return t},set:function(a){if(G(a))for(var b in a)t[b]=a[b]}});break;case"unique":Object.defineProperty(this,"unique",{get:function(){return u},set:function(a){_.each(a,function(a){u.push(a)})}});break;case"datatype":return void console.error("missing functionality")}Object.defineProperty(this,"div_id",{get:function(){return e}}),Object.defineProperty(this,"filterdata",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(this,"limit",{get:function(){return w},set:function(a){w=a}}),Object.defineProperty(this,"mode",{get:function(){return f}}),Object.defineProperty(this,"offset",{get:function(){return y},set:function(a){y=a}}),Object.defineProperty(this,"impacts",{get:function(){return x},set:function(a){E(a)&&x.push(a)}}),Object.defineProperty(this,"alias",{get:function(){return z},set:function(a){if(columns=Object.keys(a),columns.length<1)return void console.warn("Need atleast 1 alias name to add");for(var b in a)a.hasOwnProperty(b)&&(z[b]=a[b])}}),Object.defineProperty(this,"sort",{get:function(){return v},set:function(a){for(var b in a){if(n.isBlank(b))return void console.error("Column name is undefined in sort.");(n.isBlank(a[b])||"asc"!=a[b]&&"desc"!=a[b])&&(a[b]="asc")}v=a}}),this.filter=function(){Object.defineProperty(this,"filters",{get:function(){return r},set:function(a){B(a)}});var a={add:function(a){F(a)&&(A(a),"local"==g&&B(a))},remove:function(a,b,c){C(a,b,c),D(a,b,c)}};return a},this.addImpacts=function(a,b){if(E(a)){len=a.length;for(var c=0;len>c;c++)x.push(a[c]),b&&(related_pykquery=window[a[c]],related_pykquery.impacts=[this.div_id])}};var A=function(a){for(var b=!0,c=0;c<r.length;c++){var d=r[c];if(d.column_name==a.column_name&&d.condition_type==a.condition_type){if("values"==d.condition_type){var e=n.is_exactly_same(a["in"],d["in"]),f=n.is_exactly_same(a.not_in,d.not_in);if(1==f&&1==e)return console.warn("Clean up your JS: Same filter cannot add"),!1;d["in"]=n.concat_and_uniq(d["in"],a["in"]),d.not_in=n.concat_and_uniq(d.not_in,a.not_in),r[c]=d,b=!1;break}if("range"==d.condition_type){var g=a.condition,h=d.condition;if(g.min==h.min&&g.max==h.max&&g.not==h.not)return console.warn("Clean up your JS: Same filter cannot add"),!1;b=!0}}}1==b&&r.push(a)},B=function(a){if("local"==g)for(var b=x.length,c=0;b>c;c++){console.log(x[c]);var d=window[x[c]];d.filters=a}},C=function(a,b,c){for(var d=r.length,e=0;d>e;e++)if(r[e].column_name==a&&r[e].condition_type==b)if("values"==b)r[e]["in"]=n.subtract_array(r[e]["in"],c["in"]),r[e].not_in=n.subtract_array(r[e].not_in,c.not_in);else if("range"==b){var f=c.min,g=c.max;n.isBlank(f)||n.isBlank(g)||f==r[e].condition.min&&g==r[e].condition.max&&r.splice(e,1)}},D=function(a,b,c){if("local"==g)for(var d=impacts.length,e=0;d>e;e++){var f=window[impacts[e]];f.removeFilterInQuery(a,b,c)}},E=function(a){var b,c=a.length;b="local"===g?"global":"local";for(var d=0;c>d;d++){var e=window[a[d]];if(e&&e.scope===g)return console.error("A "+g+" can only impact "+b+"."),!1}return!0},F=function(a){return 0==Object.keys(a).length?(console.error("Empty filter object is not allowed."),!1):n.isBlank(a.column_name)?(console.error("column_name cannot be empty."),!1):n.isBlank(a.next)||"OR"==a.next||"AND"==a.next?"range"==a.condition_type?n.isBlank(a.condition)?(console.error("condition cannot be empty."),!1):n.isBlank(a.condition.min)&&n.isBlank(a.condition.max)?(console.error("Either min or max or both must always be present."),!1):!0:"values"==a.condition_type?n.isBlank(a.not_in)&&n.isBlank(a["in"])?(console.error("Either in or not_in or both must always be present."),!1):void 0!=a.not_in&&void 0!=a["in"]&&0==a.not_in.length&&0==a["in"].length?(console.error("Either in or not_in or both must always be present."),!1):!0:(console.error(e+": condition_type must be one of "+["range","values"]),!1):(console.error("next must either be empty or OR or AND."),!1)},G=function(a){var b=["min","max","avg","sum","median","count"];if(0==Object.keys(a).length)return console.error("Metrics object cannot be empty."),!1;for(var c in a){if(n.isBlank(c))return console.error("Column name is undefined in metrics."),!1;if(n.isBlank(a[c])||0==a[c].length)return console.error("Please pass an Array of metric functions for column name"+c),!1;for(var d=a[c].length,e=0;d>e;e++)if(b.indexOf(a[c][e])<=-1)return console.error("Wrong metric function passed for column name"+c),!1}return!0};this.call=function(){var a=this,b={getData:function(){if("local"==g)return filterdata=H(I(a));filterdata=H(I(a));for(var b=impacts.length,c=0;b>c;c++){var d=window[impacts[c]];d.filterdata=d.call()}},flushData:function(){filterdata=""}};return b};var H=function(a){if("inbrowser"==h)var b=new PykQuery.adapter.inbrowser.init(a);else var b=new PykQuery.adapter.rumi.init(a);var c=b.call();return console.log(c),c},I=function(a){var b={},c=Object.getOwnPropertyNames(a);for(var d in c)0==a.propertyIsEnumerable(c[d])&&(b[c[d]]=a[c[d]]);return b};this.storeObjectInMemory=function(a){document.getElementById(e).setAttribute("pyk_object",a)}},PykQuery.adapter={},PykQuery.adapter.rumi={},PykQuery.adapter.rumi.init=function(a){return response=ajax_query_pykquery(a),console.log(a),response};var ajax_query_pykquery=function(a){var b;b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),b.onreadystatechange=function(){if(4==b.readyState){if(200==b.status)return b.responseText;console.error(400==b.status?"There was an error 400":"something else other than 200 was returned")}},b.open("POST","filter/get_data",!1),b.setRequestHeader("Content-Type","application/json;charset=UTF-8"),b.send(JSON.stringify(a)),b.send()};PykQuery.adapter={},PykQuery.adapter.inbrowser={},PykQuery.adapter.inbrowser.init=function(a){var b,c=a;global_divid_for_raw_data=window[a.global_divid_for_raw_data],b=global_divid_for_raw_data.rawdata,this.call=function(){var e,f=a.mode;switch(void 0!=c.filters&&c.filters.length>0&&(console.log("start filter"),b=j(c)),f){case"aggregation":e=d(c);break;case"unique":break;case"datatype":break;default:console.log("wrong condition type")}return e};var d=function(a){var c,d=a.metrics;c=_.groupBy(b,a.dimensions[0]);for(var j in d){switch(d[j][0]){case"count":c=e(c,j);break;case"sum":c=f(c,j);break;case"min":c=g(c,j);break;case"max":c=h(c,j);break;case"extent":c=i(c,j)}return c}},e=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,e.count=a.length,c.push(e)}),console.log(c),c},f=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,d.push(f),f[c]=_.sum(b,function(a){return a[c]}),d.push(f)}),console.log(d),d},g=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.min=_.min(a,function(a){return a[b]}),c.push(e)}),console.log(c),c},h=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.max=_.max(a,function(a){return a[b]}),c.push(e)}),console.log(c),c},i=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.extent=_.extent(a,function(a){return a[b]}),c.push(e)}),console.log(c),c},j=function(a){var b=a.filters;console.log(a.select,b);for(var c=b.length,d=0;c>d;d++)switch(b[d].condition_type){case"values":return console.log("---- value code"),k(b[d],a.select);case"range":return console.log("---- range code"),l(b[d],a.select);case"datatype":break;default:console.log("wrong condition type")}},k=function(a,b){var c,d=a["in"],e=a.not_in,f=a.column_name;return c=_.filter(data,function(a){return e.indexOf(a[f])<0?a:void 0}),c=_.filter(c,function(a){return d.indexOf(a[f])>-1?a:void 0}),0!=b.length&&(c=_.map(c,function(a){return _.pick(a,b)})),console.log("value filter completed"),c},l=function(a,c){console.log(c);var d,e=a.condition.min,f=a.condition.max,g=a.column_name;return console.log(e,f),d=_.filter(b,function(a){return a[g]<=f&&a[g]>=e?a:void 0}),0!=c.length&&(d=_.map(d,function(a){return _.pick(a,c)})),console.log("rangeFilter done----"),d}};