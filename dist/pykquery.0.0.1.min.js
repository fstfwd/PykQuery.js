PykUtil={},PykUtil.init=function(){this.pushToArray=function(a,b){return 0==a.length?a=[b]:a.push(b),a},this.concat_and_uniq=function(a,b){return void 0!=a&&void 0!=b&&(a=a.concat(b).filter(function(a,b,c){return c.indexOf(a)===b})),a},this.is_exactly_same=function(a,b){if(void 0!=a&&void 0!=b){var c=a.length==b.length&&a.every(function(a,c){return a===b[c]});return c}return!1},this.subtract_array=function(a,b){if(void 0!=a&&void 0!=b)for(var c=0;c<b.length;c++){var d=a.indexOf(b[c]);d>-1&&a.splice(d,1)}return a},this.isBlank=function(a){}};var PykQuery={};PykQuery.global_names=[],PykQuery.local_names=[],PykQuery.init=function(a,b,c,d){that=this;var e,f,g,h,i,j,k,l,m=["aggregation","unique","select","datatype","global"],n=["local","global"],o=["inbrowser","rumi"],p=new PykUtil.init;if(!(m.indexOf(a)>-1&&n.indexOf(b)>-1&&!p.isBlank(c)&&o.indexOf(d)>-1))return-1==m.indexOf(f)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": mode has invalid value. It should be one of "+m),-1==n.indexOf(g)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope has invalid value. It should be one of "+n),-1==o.indexOf(h)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": adapters has invalid value. It should be one of "+o),p.isBlank(divid)&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": DivID cannot be undefined."),"global"==f&&"global"!=g&&console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",divid+": scope and mode both should be global."),!1;if(f=a,g=b,h=d,e="local"==g?c.replace("#",""):c,i="global"==g?_.find(PykQuery.global_names,function(a){return a==e}):null,j="local"==g?_.find(PykQuery.local_names,function(a){return a==e}):null,"global"==f&&"global"!=g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": scope and mode both should be global."),!1;if(void 0==i&&"global"==g)PykQuery.global_names.push(e),flag=!0;else{if(void 0!=j||"local"!=g)return flag=!1,!1;PykQuery.local_names.push(e),flag=!0}var q,r,s,t=[],u=[],v={},w=[],x={},y=2e3,z=[],A=0,B={};switch("global"==f&&"global"==g&&"inbrowser"==h&&Object.defineProperty(this,"rawdata",{get:function(){return r},set:function(a){r=a}}),"local"==g&&"inbrowser"==h&&Object.defineProperty(this,"global_divid_for_raw_data",{get:function(){return s},set:function(a){s=a}}),"rumi"==h&&Object.defineProperty(this,"datastoreurl",{get:function(){return data_store_url},set:function(a){data_store_url=a}}),Object.defineProperty(this,"scope",{get:function(){return g}}),f){case"select":Object.defineProperty(this,"select",{get:function(){return w},set:function(a){w=a}});break;case"aggregation":Object.defineProperty(this,"dimensions",{get:function(){return u},set:function(a){_.each(a,function(a){u.push(a)})}}),Object.defineProperty(this,"metrics",{get:function(){return v},set:function(a){if(J(a))for(var b in a)v[b]=a[b]}});break;case"unique":Object.defineProperty(this,"unique",{get:function(){return w},set:function(a){_.each(a,function(a){w.push(a)})}});break;case"datatype":console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","datatype is currently a missing functionality.")}Object.defineProperty(this,"div_id",{get:function(){return e}}),Object.defineProperty(this,"selecteddomid",{get:function(){return k},set:function(a){k=a}}),Object.defineProperty(this,"localdividtriggeringevent",{get:function(){return l},set:function(a){l=a}}),Object.defineProperty(this,"filterdata",{get:function(){return q},set:function(a){q=a}}),Object.defineProperty(this,"limit",{get:function(){return y},set:function(a){y=a}}),Object.defineProperty(this,"mode",{get:function(){return f}}),Object.defineProperty(this,"offset",{get:function(){return A},set:function(a){A=a}}),Object.defineProperty(this,"impacts",{get:function(){return z},set:function(a){H(a)&&z.push(a)}}),Object.defineProperty(this,"alias",{get:function(){return B},set:function(a){if(columns=Object.keys(a),columns.length<1)return void console.warn("Need atleast 1 alias name to add");for(var b in a)a.hasOwnProperty(b)&&(B[b]=a[b])}}),Object.defineProperty(this,"sort",{get:function(){return x},set:function(a){for(var b in a){if(p.isBlank(b))return void console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in sort.");(p.isBlank(a[b])||"asc"!=a[b]&&"desc"!=a[b])&&(a[b]="asc")}x=a}}),this.filter=function(){Object.defineProperty(this,"filters",{get:function(){return t},set:function(a){t=a}})},this.addFilter=function(a,b){this.filters||this.filter(),I(a)&&(b&&"global"==g?E(a):b&&"local"==g?(a.local_div_id_triggering_event=e,F(a),O()):(b||"global"!=g)&&(b||"local"!=g||E(a)))},this.resetFilters=function(){"global"==g?t=[]:console.error("You cannot reset a local. Please run it on a Global.")},this.removeFilter=function(a,b,c,d){I(name)&&(d&&"global"==g?C(a,b,c):d&&"local"==g?D(a,b,c):(d||"global"!=g)&&(d||"local"!=g||C(a,b,c)))};var C=function(a,b,c){for(var d=t.length,e=0;d>e;e++)if(t[e].column_name==a&&t[e].condition_type==b)if("values"==b)t[e]["in"]=p.subtract_array(t[e]["in"],c["in"]),t[e].not_in=p.subtract_array(t[e].not_in,c.not_in);else if("range"==b){var f=c.min,g=c.max;p.isBlank(f)||p.isBlank(g)||f==t[e].condition.min&&g==t[e].condition.max&&t.splice(e,1)}},D=function(a,b,c){if("local"==g)for(var d=impacts.length,e=0;d>e;e++){var f=window[impacts[e]];f.removeFilterInQuery(a,b,c)}},E=function(a){for(var b=!0,c=0;c<t.length;c++){var d=t[c];if(d.column_name==a.column_name&&d.condition_type==a.condition_type){if("values"==d.condition_type){var e=p.is_exactly_same(a["in"],d["in"]),f=p.is_exactly_same(a.not_in,d.not_in);if(1==f&&1==e)return console.warn("Clean up your JS: Same filter cannot add"),!1;d["in"]=p.concat_and_uniq(d["in"],a["in"]),d.not_in=p.concat_and_uniq(d.not_in,a.not_in),t[c]=d,b=!1;break}if("range"==d.condition_type){var g=a.condition,h=d.condition;if(g.min==h.min&&g.max==h.max&&g.not==h.not)return console.warn("Clean up your JS: Same filter cannot add"),!1;b=!0}}}1==b&&t.push(a)},F=function(a){if("local"==g)for(var b=z.length,c=0;b>c;c++){var d=window[z[c]];d.addFilter(a,!0,e)}};this.addImpacts=function(a,b){window[a[c]];if(H(a)){len=a.length;for(var c=0;len>c;c++)z.push(a[c]),G(this,a[0]),b&&(G(window[a[c]],this.div_id),related_pykquery=window[a[c]],related_pykquery.impacts=[this.div_id])}};var G=function(a,b){"inbrowser"===h&&"local"===a.scope&&(a.global_divid_for_raw_data||(a.global_divid_for_raw_data=b))},H=function(a){var b,c=a.length;b="local"===g?"global":"local";for(var d=0;c>d;d++){var e=window[a[d]];if(e&&e.scope===g)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","A "+g+" can only impact a "+b+"."),!1}return!0},I=function(a){return 0==Object.keys(a).length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Empty filter object is not allowed."),!1):p.isBlank(a.column_name)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'column_name' cannot be empty."),!1):p.isBlank(a.next)||"OR"==a.next||"AND"==a.next?"range"==a.condition_type?p.isBlank(a.condition)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'condition' cannot be empty."),!1):p.isBlank(a.condition.min)&&p.isBlank(a.condition.max)?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'min' or 'max' or both must always be present."),!1):!0:"values"==a.condition_type?p.isBlank(a.not_in)&&p.isBlank(a["in"])?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):void 0!=a.not_in&&void 0!=a["in"]&&0==a.not_in.length&&0==a["in"].length?(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Either 'in' or 'not_in' or both must always be present."),!1):!0:(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px",e+": 'condition_type' must be one of "+["range","values"]+"."),!1):(console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'next' must either be empty or OR or AND."),!1)},J=function(a){var b=["min","max","avg","sum","median","count"];if(0==Object.keys(a).length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","'metrics' object cannot be empty."),!1;for(var c in a){if(p.isBlank(c))return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Column name is undefined in 'metrics'."),!1;if(p.isBlank(a[c])||0==a[c].length)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Please pass an Array of metric functions for column name '"+c+"'."),!1;for(var d=a[c].length,e=0;d>e;e++)if(b.indexOf(a[c][e])<=-1)return console.error("%c[Error - PykQuery] ","color: red;font-weight:bold;font-size:14px","Wrong metric function passed for column name '"+c+"'."),!1}return!0};this.flushToGet=function(){if("local"==g){var a=q;return q="",a}console.error("Cannot call flushToGet to on a Global PykQuery.")},this.call=function(){var a=this;if("local"==g)M(N(a));else for(var b=z.length,c=0;b>c;c++){var d=window[z[c]];d.filter_data=d.call()}return!0};var K=function(){if("local"==g){for(var a=that.filters,b=z.length,c=0;b>c;c++){var d=window[z[c]].filters;d&&d.localdividtriggeringevent!==e&&(a=_.flatten(d,a))}return a}console.error("Cannot call generateConsolidatedFiltersArray to on a Global PykQuery.")},L=function(a){if(a)for(var b=0;b<a.length;b++)document.getElementById(a[b].selected_dom_id).className+=" selected"},M=function(a){var b=K();L(b);if("inbrowser"==h){var c=new PykQuery.adapter.inbrowser.init(a,b);return q=c.call()}var c=new PykQuery.adapter.rumi.init(a);return c.call(function(a){return q=a})},N=function(a){var b={},c=Object.getOwnPropertyNames(a);for(var d in c)0==a.propertyIsEnumerable(c[d])&&(b[c[d]]=a[c[d]]);return b};this.storeObjectInMemory=function(a){document.getElementById(e).setAttribute("pyk_object",a)};this.toSql=function(){that=this;var a,b,c=that.filters,d=that.mode,e=that.unique,f=that.metrics,g=that.select,h=that.sort,i=that.dimensions,j=that.limit,k=that.offset,l=that.div_id,m="__",n=that.columns,o=[],p=[],q=[],r="",s="FROM "+m+" ",t=[],u="",v="",w="",x="",y=!1;if(i&&"aggregation"==d){if(f&&0==_.isEmpty(f))for(var z in f){len=f[z].length;for(var A=0;len>A;A++)o.push(f[z][A]+"("+z+")")}if(0==_.isEmpty(i))for(var z=0;z<i.length;z++)0==_.has(f,i[z])&&(o.push(i[z]),p.push(i[z]))}if(g&&"select"==d){if(0===_.intersection(n,g).length&&g.toString()!==["*"].toString())return!1;_.each(g,function(a){o.push(a)})}if(e&&"unique"==d){if(0===_.intersection(n,e).length)return!1;_.each(e,function(a){o.push(a)})}if(r=1==_.isEmpty(o)&&1==_.isEmpty(i)&&"unique"!=d?"SELECT * ":"unique"==d?"SELECT DISTINCT "+o.join(", ")+" ":"SELECT "+o.join(", ")+" ",c&&0==_.isEmpty(c)&&(a=!1,_.each(c,function(d,e){switch(t[e]="",d.condition_type){case"values":b=[],d["in"]&&0!==d["in"].length&&(y=!0,t[e]+=d.column_name+" IN (",_.each(d["in"],function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.not_in&&0!==d.not_in.length&&(t[e]+=y?"AND "+d.column_name+" NOT IN (":d.column_name+" NOT IN (",_.each(d.not_in,function(a){t[e]+=a+", "}),t[e]=t[e].slice(0,-2)+") "),d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1;break;case"range":0==_.isEmpty(d.condition)&&(t[e]+=d.column_name+" ",d.condition.not&&(t[e]+="NOT "),t[e]+="BETWEEN "+d.condition.min+" AND "+d.condition.max+" ",d.next&&e!=c.length-1?(t[e]=t[e]+d.next,a=d.next):a=!1);break;case"data_types":}})),i&&"aggregation"===d&&(u="GROUP BY "+p.join(", ")+" "),h&&0==_.isEmpty(h)){v="ORDER BY ";for(key in h)v+=key+" "+h[key]+", ";v=v.slice(0,-2)+" "}w=j?"LIMIT "+j+" ":w,x=k?"OFFSET "+k+" ":x,q=l+": \n "+r+" \n "+s+" \n WHERE";for(var B=t.length,z=0;B>z;z++)q=q+" \n	 "+t[z];return q=q+" \n "+u+" \n "+v+" \n "+w+" \n "+x,console.log(q),q},this.filterList=function(a){$("#"+a).empty(),$("#"+a).append("<div class='filter_list'></div>"),O(t,a),$(".filter_remove").unbind("click"),$(document).on("click",".filter_remove",function(){var b=$(this).attr("id").split("filter_remove_");P(b[1],t,a)})};var O=function(){len=t.length,filter_values="values in filter",$(".filter_list").empty();for(var a=0;len>a;a++)$(".filter_list").append("<div class='filter_block' id ='filter_block"+a+"'></div>"),$("#filter_block"+a).append("<div class ='filter_value"+a+"'>"+filter_values+"</div>"),$("#filter_block"+a).append("<div id ='filter_remove_"+a+"'class ='filter_remove'>remove</div>")},P=function(a){t.splice(a,1),O()}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.rumi={},PykQuery.adapter.rumi.init=function(a){this.call=function(b){var c,d;c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c.onreadystatechange=function(){4==c.readyState&&(201==c.status?(d=c.responseText,console.log(c.responseText,d),b(d)):console.error(400==c.status?"There was an error 400":"something else other than 200 was returned"))},c.open("POST","http://192.168.0.121:9292/v1/filter/show",!1),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),console.log(d,"------response"),c.send(JSON.stringify(a))}},PykQuery.adapter=PykQuery.adapter||{},PykQuery.adapter.inbrowser={},PykQuery.adapter.inbrowser.init=function(a,b){global_divid_for_raw_data=window[a.global_divid_for_raw_data],c=global_divid_for_raw_data.rawdata;var c,d=a;global_divid_for_raw_data=window[a.global_divid_for_raw_data],c=global_divid_for_raw_data.rawdata,d.filters=b,this.call=function(){var b,c=a.mode;switch(void 0!=d.filters&&d.filters.length>0&&k(d),c){case"aggregation":b=e(d);break;case"unique":break;case"datatype":}return b};var e=function(a){var b=a.metrics;local_data=_.groupBy(c,a.dimensions[0]);for(var d in b){switch(b[d][0]){case"count":local_data=f(local_data,d);break;case"sum":local_data=g(local_data,d);break;case"min":local_data=h(local_data,d);break;case"max":local_data=i(local_data,d);break;case"extent":local_data=j(local_data,d)}return local_data}},f=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=b.length,d.push(f)}),d},g=function(b,c){var d=[];return _.map(b,function(b,e){var f={};f[a.dimensions[0]]=e,f[c]=_.sum(b,function(a){return a[c]}),d.push(f)}),d},h=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.min=_.min(a,function(a){return a[b]}),c.push(e)}),c},i=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.max=_.max(a,function(a){return a[b]}),c.push(e)}),c},j=function(a,b){var c=[];return _.map(a,function(a,d){var e={};e[b]=d,c.push(e),e.extent=_.extent(a,function(a){return a[b]}),c.push(e)}),c},k=function(a){var b,d=a.mode,e=a.filters,f=e.length;b="select"==a.mode?a.select:[];for(var g=0;f>g;g++)switch(e[g].condition_type){case"values":console.log("---- value code"),l(e[g],b,d);break;case"range":console.log("---- range code"),m(e[g],b);break;case"datatype":}return c},l=function(a,b,d){var e=a["in"],f=a.not_in,g=a.column_name;c=_.filter(c,function(a){return!f||f.indexOf(a[g])<0?a:void 0}),c=_.filter(c,function(a){return e&&e.indexOf(a[g])>-1?a:void 0}),0!=b.length&&"select"===d&&(c=_.map(c,function(a){return _.pick(a,b)}))},m=function(a,b,d){var e=a.condition.min,f=a.condition.max,g=a.column_name;c=_.filter(c,function(a){return a[g]<=f&&a[g]>=e?a:void 0}),0!=b.length&&"select"===d&&(c=_.map(c,function(a){return _.pick(a,b)}))}};